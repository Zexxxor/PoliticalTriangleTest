<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<link href="./style.css" rel="stylesheet" type="text/css">
<title>Дополнительные вопросы</title>
<link rel="icon" type="x-icon" href="icon.png">
<link rel="shortcut icon" type="x-icon" href="icon.png">
</head>
<body>
<div class="content-wrapper">
  <form id="surveyForm">
    <div class="list-text">Ваш биологический пол</div>
    <select name="sex" required>
      <option value="">Выберите вариант</option>
      <option>Мужской</option>
      <option>Женский</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <div class="list-text">Ваш гендер</div>
    <select name="gender" required>
      <option value="">Выберите вариант</option>
      <option>Мужской</option>
      <option>Женский</option>
      <option>Другой/Небинарный</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <div class="list-text">Ваш возраст</div>
    <select name="age" required>
      <option value="">Выберите вариант</option>
      <option>Менее 16 лет</option>
      <option>16-19 лет</option>
      <option>20-29 лет</option>
      <option>30-39 лет</option>
      <option>40-49 лет</option>
      <option>50-59 лет</option>
      <option>60-69 лет</option>
      <option>70 и более лет</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <div class="list-text">Ваше образование</div>
    <select name="education" required>
      <option value="">Выберите вариант</option>
      <option>Нет образования</option>
      <option>Начальное</option>
      <option>Неполное среднее</option>
      <option>Полное среднее</option>
      <option>Среднее профессиональное</option>
      <option>Незаконченное высшее (учусь)</option>
      <option>Высшее (бакалавриат/специалист)</option>
      <option>Магистратура/аспирантура</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <div class="list-text">Ваш доход</div>
    <select name="income" required>
      <option value="">Выберите вариант</option>
      <option>Хватает только на еду и предметы первой необходимости</option>
      <option>Хватает на еду, предметы первой необходимости и иногда бытовую технику</option>
      <option>Хватает на регулярные покупки бытовой техники и недорогие поездки внутри страны</option>
      <option>Хватает на регулярные поездки за границу и досуг (рестораны, развлечения, хобби)</option>
      <option>Хватает на авто с обновлением каждые 5–7 лет</option>
      <option>Хватает на авто каждые 3–4 года и приобретение недвижимости без ипотеки</option>
      <option>Хватает на несколько объектов недвижимости, предметы роскоши и инвестиции</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <div class="list-text">Ваше семейное положение</div>
    <select name="family" required>
      <option value="">Выберите вариант</option>
      <option>Не женат/не замужем, детей нет</option>
      <option>Не женат/не замужем, есть дети</option>
      <option>В браке, детей нет</option>
      <option>В браке, есть дети</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <div class="list-text">Ваша страна (полное официальное название)</div>
    <input type="text" name="country" required>

    <div class="list-text">Ваш регион (полное официальное название)</div>
    <input type="text" name="region" required>

    <div class="list-text">Ваши политические взгляды по классическому политическому компасу (или просто ваши взгляды)</div>
    <select name="views" required>
      <option value="">Выберите вариант</option>
      <option>Анархо-капитализм</option>
      <option>Классический либерализм (джефферсонизм)</option>
      <option>Неолиберализм</option>
      <option>Право-центризм</option>
      <option>Консерватизм</option>
      <option>Реакционизм</option>
      <option>Абсолютизм</option>
      <option>Сталинизм</option>
      <option>Марксизм-ленинизм</option>
      <option>Социализм</option>
      <option>Лево-центризм</option>
      <option>Социал-демократия</option>
      <option>Либертарианский социализм (зелёные)</option>
      <option>Анархо-коммунизм</option>
      <option>Центризм</option>
      <option>Фашизм/Национал-социализм</option>
      <option>Неоконсерватизм</option>
      <option>Анархизм</option>
      <option>Троцкизм</option>
      <option>Предпочитаю не указывать</option>
    </select>

    <button type="submit" class="button">Отправить результаты</button>
  </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const webhookUrl = 'https://script.google.com/macros/s/AKfycbxnm46a8iI0p8NuQlnZqw0GsVP272jnAuB0KAaqMMuXq2-pG_eaPqfIj2RKTXm9847TPg/exec';
  const form = document.getElementById('surveyForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(form));
    const dataStr = localStorage.getItem('triangleResult');
    let data = {};
    try {
      data = JSON.parse(dataStr) || {};
    } catch (e) {
      data = {};
    }

    const n_L1 = data.n_L1 || 0;
    const n_L2 = data.n_L2 || 0;
    const n_I1 = data.n_I1 || 0;
    const n_I2 = data.n_I2 || 0;
    const n_A1 = data.n_A1 || 0;
    const n_A2 = data.n_A2 || 0;
    const M_L1 = data.M_L1 || 0;
    const M_L2 = data.M_L2 || 0;
    const M_I1 = data.M_I1 || 0;
    const M_I2 = data.M_I2 || 0;
    const M_A1 = data.M_A1 || 0;
    const M_A2 = data.M_A2 || 0;
    const S_L = 2 * n_L1 + 4 * n_L2;
    const S_I = 2 * n_I1 + 4 * n_I2;
    const S_A = 2 * n_A1 + 4 * n_A2;
    const D_L = 2 * M_L1 + 4 * M_L2;
    const D_I = 2 * M_I1 + 4 * M_I2;
    const D_A = 2 * M_A1 + 4 * M_A2;
    const L = D_L ? S_L / D_L : 0;
    const I = D_I ? S_I / D_I : 0;
    const A = D_A ? S_A / D_A : 0;
    const m = data.D_tot ? (S_L + S_I + S_A) / data.D_tot : 0;
    let Lp, Ip, Ap;
    if (L === 0 && I === 0 && A === 0) {
      Lp = 0.5; Ip = 0.5; Ap = 0;
    } else {
      const sum = L + I + A;
      const vL = L / sum;
      const vI = I / sum;
      const vA = A / sum;
      Lp = (1 - m) * 0.5 + m * vL;
      Ip = (1 - m) * 0.5 + m * vI;
      Ap = (1 - m) * 0 + m * vA;
    }
    const xPrime = 360 + 360 * (Ap - Lp);
    const yPrime = 415.692 + 207.846 * (Lp + Ap) - 415.692 * Ip;
    const coordX = 0.32198055555555556 * xPrime - 0.18589564709769092 * yPrime + 169.029;
    const coordY = 0.18611111111111112 * xPrime + 0.3223540505951522 * yPrime - 67.0;

    const payload = { answers: data.answers, score: { x: coordX, y: coordY }, ...formData };
    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (err) {
      // ignore errors
    } finally {
      window.location.href = 'result.html';
    }
  });
});
</script>
</body>
</html>
